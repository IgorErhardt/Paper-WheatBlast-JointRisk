---
title: "ENSO_Temporal_Trend"
format: html
editor: visual
---

### Library Import

```{R}
library(tidyverse)
library(gsheet)
library(mgcv)
library(broom)
library(readxl)
library(ggplot2)
library(patchwork)
library(nlme)
library(gratia)
library(lme4)
library(glmmTMB)
library(DHARMa)
library(mvtnorm)
library(emmeans)
library(lubridate)
library(ggrepel)
library(here)
```

### Dataframe Input

Import dataframe and standardize the ONI values for NDJ and OND trimesters

```{R}
file_path <- here("InputData", "ONI_Analysis.xlsx")
dat <- read_excel(file_path)
df <- dat %>%
  mutate(
    Year       = as.integer(Year),
    MUN        = factor(MUN),
    .date = mdy(paste0(as.character(SowingDate), "-2000")),
    SowingDate = format(.date, "%d-%m"),                 
    NDJ_s      = scale(NDJ)[, 1],
    OND_s      = scale(OND)[, 1],
    Year_c     = Year - mean(Year)
  ) %>% 
  mutate(
    SowingDate = factor(SowingDate)
  )
hist(df$EpidemicProbability)
```

### Screening ENSO trimester

Fits a gls model for each ONI trimester, with partial residual autocorrelation across the years for each sowing date and locality combination. Comparison performed by comparing AIC and coefficients.

```{R}
trims <- c("DJF","JFM","FMA","MAM","AMJ","MJJ",
           "JJA","JAS","ASO","SON","OND","NDJ")

fit_list <- map(trims, \(tri) {
  x <- scale(df[[tri]])
  df_tmp <- df %>% mutate(ONI_s = as.numeric(x))
  m <- gls(EpidemicProbability ~ ONI_s + MUN + SowingDate, data = df_tmp,
           correlation = corAR1(form = ~ Year | MUN/SowingDate))
  tibble(Trimester = tri, Beta_ONI = summary(m)$tTable["ONI_s", "Value"],
         p_ONI = summary(m)$tTable["ONI_s", "p-value"], AIC = AIC(m))
})

res_tab <- bind_rows(fit_list) %>%
  arrange(AIC)
res_tab$Trimester <- factor(res_tab$Trimester, levels = trims)
res_tab
```

Screening plots

```{R}
g_beta <- ggplot(res_tab, aes(x = Trimester, y = Beta_ONI)) +
  geom_col(fill = "grey70") +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(
    x = "Trimester (ONI)",
    y = "Coeficiente β (standardized)",
    title = "Sensibilidade do risco à ENSO por trimestre"
  ) +
  theme_minimal(base_size = 13)
g_beta

g_aic <- ggplot(res_tab, aes(x = Trimester, y = AIC, group = 1)) +
  geom_line() +
  geom_point() +
  scale_y_reverse() +
  labs(
    x = "Trimester (ONI)",
    y = "AIC",
    title = "Performance by trimester"
  ) +
  theme_minimal(base_size = 13)
g_aic
```

## Beta-Mixed Effects —————————————————————–

```{R}
df <- dat %>%
  mutate(
    Year       = as.integer(Year),
    MUN        = factor(MUN),
    .date = mdy(paste0(as.character(SowingDate), "-2000")),
    SowingDate = format(.date, "%d-%m"),
    EpidemicProb_beta = (EpidemicProbability * (nrow(dat) - 1) + 0.5) / nrow(dat),
    NDJ_s      = scale(NDJ)[, 1],
    OND_s      = scale(OND)[, 1],
    Year_c     = Year - mean(Year)
  ) %>% 
  mutate(
    SowingDate = factor(SowingDate,
                        levels = unique(SowingDate[order(.date)]),
                         ordered = TRUE)
  )
```

## Beta-Mixed Main Model

```{R}
m_beta_main <- glmmTMB(
  EpidemicProb_beta ~ NDJ_s + MUN + SowingDate + (1 | Year),
  family = beta_family(link = "logit"),
  data = df
)
summary(m_beta_main)
car::Anova(m_beta_main, type = 3)
```

### NDJ x Sowing Date (Beta-Mixed)

```{R}
m_beta_sow <- glmmTMB(
  EpidemicProb_beta ~ NDJ_s * SowingDate + MUN + (1 | Year),
  family = beta_family(link = "logit"),
  data = df
)
summary(m_beta_sow)
car::Anova(m_beta_sow, type = 3)
```

### NDJ x Locality (Beta-Mixed)

```{R}
m_beta_mun <- glmmTMB(
  EpidemicProb_beta ~ NDJ_s * MUN + SowingDate + (1 | Year),
  family = beta_family(link = "logit"),
  data = df
)
summary(m_beta_mun)
car::Anova(m_beta_mun, type = 3)
```

### Diagnostics

```{R}
res_beta <- simulateResiduals(m_beta_main, n = 1000)
plot(res_beta)
testUniformity(res_beta)
testDispersion(res_beta)
testOutliers(res_beta)
```

## Beta-Mixed Predictions ———————————————————

### Global ENSO Effect

```{R}
pred_ci_glmmTMB <- function(model, newdata, nsim = 1000, seed = 1) {
  set.seed(seed)
  form_cond <- formula(model)$cond
  rhs <- as.formula(paste("~", deparse(form_cond[[3]])))
  X <- model.matrix(rhs, newdata)
  beta_hat <- fixef(model)$cond
  V <- as.matrix(vcov(model)$cond)
  need <- names(beta_hat)
  have <- colnames(X)
  missing <- setdiff(need, have)
  if (length(missing) > 0) {
    X <- cbind(X, matrix(0, nrow(X), length(missing),
                         dimnames = list(NULL, missing)))
  }
  extra <- setdiff(have, need)
  if (length(extra) > 0) {
    X <- X[, setdiff(colnames(X), extra), drop = FALSE]
  }
  X <- X[, need, drop = FALSE]
  V <- V[need, need, drop = FALSE]
  beta_sim <- mvtnorm::rmvnorm(nsim, mean = beta_hat[need], sigma = V)  # nsim x p
  eta_sim <- beta_sim %*% t(X)
  mu_sim <- plogis(eta_sim)
  fit <- predict(model, newdata = newdata, type = "response",
                 allow.new.levels = TRUE, re.form = NA)
  lwr <- apply(mu_sim, 2, quantile, probs = 0.025, na.rm = TRUE)
  upr <- apply(mu_sim, 2, quantile, probs = 0.975, na.rm = TRUE)
  newdata %>% mutate(fit = as.numeric(fit), lwr = lwr, upr = upr)
}

mun_ref <- levels(df$MUN)[1]
sow_ref <- levels(df$SowingDate)[1]
ndj_seq <- seq(min(df$NDJ_s), max(df$NDJ_s), length.out = 200)
new_global <- tibble(
  NDJ_s = ndj_seq,
  MUN   = factor(mun_ref, levels = levels(df$MUN)),
  SowingDate = factor(sow_ref, levels = levels(df$SowingDate)),
  Year  = mean(df$Year)
)
pr <- predict(
  m_beta_main,
  newdata = new_global,
  type = "link",
  se.fit = TRUE,
  re.form = NA
)
pred_global <- new_global %>%
  mutate(
    eta = as.numeric(pr$fit),
    se  = as.numeric(pr$se.fit),
    fit = plogis(eta),
    lwr = plogis(eta - 1.96 * se),
    upr = plogis(eta + 1.96 * se)
  )
gA <- ggplot(pred_global, aes(NDJ_s, fit)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2) +
  geom_line(linewidth = 1.1) +
  labs(x = "NDJ (standardized)", y = "Predicted probability",
       title = "A. Global ENSO effect (NDJ)") +
  theme_minimal(base_size = 13)
gA
```

### ENSO Effect By Sowing Date

```{R}
new_sow <- expand_grid(
  NDJ_s = ndj_seq,
  SowingDate = factor(levels(df$SowingDate), levels = levels(df$SowingDate)),
  MUN = factor(mun_ref, levels = levels(df$MUN))
)
pred_sow <- pred_ci_glmmTMB(m_beta_sow, new_sow, nsim = 300, seed = 2)
label_df <- pred_sow %>%
  filter(!is.na(fit)) %>%
  group_by(SowingDate) %>%
  slice_max(NDJ_s, n = 1, with_ties = FALSE) %>%
  ungroup()
x_range <- range(pred_sow$NDJ_s, na.rm = TRUE)
x_nudge <- 0.1 * diff(x_range) 

gC <- ggplot(pred_sow, aes(NDJ_s, fit, colour = SowingDate)) +
  geom_line(linewidth = 1.0) +
  scale_colour_viridis_d(option = "viridis", name = "Sowing date") +
  ggrepel::geom_text_repel(
    data = label_df,
    aes(x = NDJ_s, y = fit, label = SowingDate, colour = SowingDate),
    inherit.aes = FALSE,
    nudge_x = x_nudge,
    hjust = 0,
    direction = "y",
    segment.size = 0.25,
    segment.alpha = 0.6,
    size = 4.0,
    fontface = "bold",
    show.legend = FALSE,
    force = 2
  ) +
  expand_limits(x = x_range[2] + x_nudge * 1.5) +
  labs(x = "NDJ (standardized)", y = "Predicted probability", title = "B") +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none")
gC
```

### Risk x Sowing Date Gradient

```{R}
ndj_seq_heat <- seq(min(df$NDJ_s), max(df$NDJ_s), length.out = 25)
new_heat <- expand_grid(
  NDJ_s = ndj_seq_heat,
  SowingDate = factor(levels(df$SowingDate), levels = levels(df$SowingDate)),
  MUN = factor(mun_ref, levels = levels(df$MUN))
)
pred_heat <- pred_ci_glmmTMB(m_beta_sow, new_heat, nsim = 300, seed = 3)
gD <- ggplot(pred_heat, aes(NDJ_s, SowingDate, fill = fit)) +
  geom_tile() +
  scale_fill_viridis_c(
    name = "Predicted\nprobability",
    option = "viridis",
    direction = 1,   
    begin = 0.05, end = 0.95
  ) +
  labs(x = "NDJ (standardized)", y = "Sowing date",
       title = "D. Risk gradient (NDJ × sowing date)") +
  theme_minimal(base_size = 13)
gD
```

### Predicted Epidemic Probability

```{R}
emm_sd <- emmeans(
  m_beta_main,
  ~ SowingDate,
  at = list(NDJ_s = 0, MUN = mun_ref),
  type = "response"
)
pred_sd2 <- as.data.frame(emm_sd) |>
  transmute(
    SowingDate,
    fit = response,
    lwr = asymp.LCL,
    upr = asymp.UCL
  )
gB <- ggplot(pred_sd2, aes(SowingDate, fit)) +
  geom_col(fill = "#31688EFF") +
  geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.15) +
  labs(x = "Sowing date", y = "Predicted probability",
       title = "A") +
  theme_minimal(base_size = 13)
gB
```

### Paper panel

```{R}
file_path <- here("OutputData", "panel_ENSO_sow.png")
p <- gB + gC
ggsave(file_path, p,
       width = 10, height = 4, units = "in", dpi = 600)
```
